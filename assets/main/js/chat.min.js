document.addEventListener("DOMContentLoaded",()=>{var e=document.querySelector("#chat-ai");if(e){let n=e.querySelector(".chat-button"),a=e.querySelector(".chat-container");e=e.querySelector(".close-chat");if(n&&a&&e){let t=()=>{a.classList.remove("active")};n.addEventListener("click",e=>{e.stopPropagation(),a.classList.toggle("active")}),e.addEventListener("click",t),document.addEventListener("click",e=>{a.contains(e.target)||n.contains(e.target)||!a.classList.contains("active")||t()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&a.classList.contains("active")&&t()}),a.addEventListener("click",e=>{e.stopPropagation()})}}});let apiKey="AIzaSyC63x6MDMzfKSqlThu2UbGGUB0Hp1eqbkc",API_ENDPOINT="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",SYSTEM_PROMPT="",conversationHistory=[];function getCurrentTime(){var e=new Date;return String(e.getHours()).padStart(2,"0")+":"+String(e.getMinutes()).padStart(2,"0")}async function loadRules(){try{var e=await(await fetch("./assets/rule/rule.txt")).text();SYSTEM_PROMPT=`Bạn là trợ lý AI chính thức của website này. 

THÔNG TIN WEBSITE (từ rule.txt):
${e}

NHIỆM VỤ CỦA BẠN:
- Trả lời các câu hỏi DỰA TRÊN THÔNG TIN TRONG rule.txt
- Đóng vai là đại diện chính thức của website, hiểu rõ tất cả thông tin về sản phẩm/dịch vụ
- Nếu được hỏi về thông tin KHÔNG CÓ trong rule.txt, hãy lịch sự nói rằng bạn chưa có thông tin đó
- QUAN TRỌNG: TỰ ĐỘNG PHÁT HIỆN NGÔN NGỮ của người dùng và TRẢ LỜI BẰNG CHÍNH NGÔN NGỮ ĐÓ
  + Nếu họ hỏi bằng Tiếng Việt → Trả lời bằng Tiếng Việt
  + Nếu họ hỏi bằng English → Reply in English
  + Nếu họ hỏi bằng 中文 → 用中文回答
  + Nếu họ hỏi bằng 日本語 → 日本語で答える
  + Nếu họ hỏi bằng 한국어 → 한국어로 대답
  + Và hỗ trợ tất cả các ngôn ngữ khác tương tự
- KHÔNG dùng emoji hoặc icon trong câu trả lời
- Trả lời một cách tự nhiên, chuyên nghiệp nhưng thân thiện
- Luôn hướng người dùng đến các tính năng/dịch vụ của website khi phù hợp

Phong cách: Chuyên nghiệp, đa ngôn ngữ linh hoạt, am hiểu sâu về website, nhiệt tình hỗ trợ khách hàng toàn cầu.`,addMessage("Xin chào! Tôi là trợ lý ảo của website MenasGroup. Tôi có thể giúp gì cho bạn hôm nay?","ai")}catch(e){console.error("Không thể đọc file rule.txt:",e),SYSTEM_PROMPT=`Bạn là trợ lý AI thân thiện và đa ngôn ngữ. 
- TỰ ĐỘNG PHÁT HIỆN ngôn ngữ của người dùng và TRẢ LỜI BẰNG CHÍNH NGÔN NGỮ ĐÓ
- KHÔNG dùng emoji hoặc icon
- Trả lời câu hỏi một cách hữu ích và lịch sự bằng bất kỳ ngôn ngữ nào`,addMessage("Xin chào! Tôi là trợ lý AI đa ngôn ngữ. Tôi có thể giúp gì cho bạn?","ai")}}function addMessage(e,t){var n=document.getElementById("chatMessages"),a=document.createElement("div"),c=(a.className="message "+t,document.createElement("div")),t=(c.className="message-content","ai"===t&&(e=removeMarkdown(e)),c.textContent=e,document.createElement("div"));t.className="message-time",t.textContent=getCurrentTime(),a.appendChild(c),a.appendChild(t),n.appendChild(a),n.scrollTop=n.scrollHeight}function removeMarkdown(e){let t=e.replace(/^#{1,6}\s+(.+)$/gm,"$1\n").replace(/\*\*(.+?)\*\*/g,"$1").replace(/__(.+?)__/g,"$1").replace(/\*(.+?)\*/g,"$1").replace(/_(.+?)_/g,"$1").replace(/~~(.+?)~~/g,"$1").replace(/`(.+?)`/g,"$1").replace(/```[\s\S]*?```/g,"").replace(/\[(.+?)\]\(.+?\)/g,"$1").replace(/!\[.*?\]\(.+?\)/g,"").replace(/^\s*[\*\-\+]\s+(.+)$/gm,"• $1").replace(/^\s*(\d+)\.\s+(.+)$/gm,"$1. $2").replace(/^>\s+/gm,"").replace(/^[\-\*_]{3,}$/gm,"").trim();return t=t.replace(/[\u{1F600}-\u{1F64F}]/gu,"").replace(/[\u{1F300}-\u{1F5FF}]/gu,"").replace(/[\u{1F680}-\u{1F6FF}]/gu,"").replace(/[\u{1F700}-\u{1F77F}]/gu,"").replace(/[\u{1F780}-\u{1F7FF}]/gu,"").replace(/[\u{1F800}-\u{1F8FF}]/gu,"").replace(/[\u{1F900}-\u{1F9FF}]/gu,"").replace(/[\u{1FA00}-\u{1FA6F}]/gu,"").replace(/[\u{1FA70}-\u{1FAFF}]/gu,"").replace(/[\u{2600}-\u{26FF}]/gu,"").replace(/[\u{2700}-\u{27BF}]/gu,"").replace(/[\u{FE00}-\u{FE0F}]/gu,"").replace(/[\u{1F1E0}-\u{1F1FF}]/gu,"").replace(/[\u{E0020}-\u{E007F}]/gu,"").trim()}function showTyping(){document.getElementById("typingIndicator").classList.add("active");var e=document.getElementById("chatMessages");e.scrollTop=e.scrollHeight}function hideTyping(){document.getElementById("typingIndicator").classList.remove("active")}async function sendMessage(){var e=document.getElementById("chatInput"),t=e.value.trim();if(t){addMessage(t,"user"),e.value="",conversationHistory.push({role:"user",parts:[{text:t}]}),showTyping(),document.getElementById("sendBtn").disabled=!0,e.disabled=!0;try{var n,a=[{role:"user",parts:[{text:SYSTEM_PROMPT}]},...conversationHistory],c=await(await fetch(API_ENDPOINT+"?key="+apiKey,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:a,generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:1024}})})).json();hideTyping(),c.candidates&&c.candidates[0]?(addMessage(n=c.candidates[0].content.parts[0].text,"ai"),conversationHistory.push({role:"model",parts:[{text:n}]})):c.error?addMessage("Lỗi: "+c.error.message,"ai"):addMessage("Không thể nhận được phản hồi từ AI","ai")}catch(e){hideTyping(),addMessage("Lỗi kết nối: "+e.message,"ai")}document.getElementById("sendBtn").disabled=!1,e.disabled=!1,e.focus()}}function handleKeyPress(e){"Enter"===e.key&&sendMessage()}window.addEventListener("DOMContentLoaded",loadRules);